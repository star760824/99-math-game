<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>99ä¹˜æ³•æŒ‘æˆ°ç‹</title>
    
    <!-- è¼‰å…¥æ ¸å¿ƒå¼•æ“ -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* é˜²æ­¢æ‰‹æ©Ÿç‰ˆé•·æŒ‰é¸å–æ–‡å­—ï¼Œè®“é«”é©—æ›´åƒ App */
        body {
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #fff1f2; /* bg-rose-50 */
            margin: 0;
            padding: 0;
        }
        /* è‡ªå®šç¾©å‹•ç•« */
        @keyframes bounce {
            0%, 100% { transform: translateY(-10%); }
            50% { transform: translateY(0); }
        }
        .animate-bounce { animation: bounce 1.5s infinite; }
        @keyframes scale-in {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¼‰å…¥ç•«é¢æ¨£å¼ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff1f2;
            z-index: 50;
            color: #fb7185;
            font-family: sans-serif;
            transition: opacity 0.5s;
        }
        
        /* æ–æ™ƒå‹•ç•« (ç­”éŒ¯æ™‚) */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        
        /* æ·¡å…¥å‹•ç•« */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-rose-50 font-sans text-slate-600">
    
    <!-- é è¨­è¼‰å…¥ç•«é¢ -->
    <div id="loading-screen">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ»</div>
        <h2 style="font-size: 24px; font-weight: bold;">æ­£åœ¨æº–å‚™é­”æ³•...</h2>
        <p style="margin-top: 10px; color: #94a3b8;">(å¦‚æœå¡å¾ˆä¹…ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå–”ï¼)</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // éŒ¯èª¤æ•æ‰
        window.onerror = function(message, source, lineno, colno, error) {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2 style="color: #ef4444; font-size: 20px;">å“å‘€ï¼ç™¼ç”ŸéŒ¯èª¤äº†</h2>
                        <p style="color: #64748b; margin-top: 10px;">${message}</p>
                    </div>
                `;
            }
        };

        const { useState, useEffect } = React;

        // --- ç°¡æ˜“åœ–ç¤ºå…ƒä»¶ ---
        const IconBase = ({ d, className = "", size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
            </svg>
        );

        const Star = (p) => <IconBase {...p} d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />;
        const Heart = (p) => <IconBase {...p} d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />;
        const Trophy = (p) => <IconBase {...p} d={["M6 9H4.5a2.5 2.5 0 0 1 0-5H6", "M18 9h1.5a2.5 2.5 0 0 0 0-5H18", "M4 22h16", "M8 22v-4.172a2 2 0 0 1 .586-1.414L12 13l3.414 3.414A2 2 0 0 1 16 17.828V22", "M12 13V2"]} />;
        const BookOpen = (p) => <IconBase {...p} d={["M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z", "M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"]} />;
        const Play = (p) => <IconBase {...p} d="M5 3l14 9-14 9V3z" />;
        const ArrowLeft = (p) => <IconBase {...p} d={["M19 12H5", "M12 19l-7-7 7-7"]} />;
        const RefreshCw = (p) => <IconBase {...p} d={["M23 4v6h-6", "M1 20v-6h6", "M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"]} />;
        const CheckCircle = (p) => <IconBase {...p} d={["M22 11.08V12a10 10 0 1 1-5.93-9.14", "M22 4L12 14.01l-3-3"]} />;
        const XCircle = (p) => <IconBase {...p} d={["M10 11.08V12a10 10 0 1 1-5.93-9.14", "M15 9l-6 6", "M9 9l6 6"]} />;
        const Frown = (p) => <IconBase {...p} d={["M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z", "M9 9h.01", "M15 9h.01", "M9 14s1.5 1.5 3 1.5 3-1.5 3-1.5"]} />;
        const Award = (p) => <IconBase {...p} d={["M12 15a7 7 0 1 0 0-14 7 7 0 0 0 0 14z", "M8.21 13.89L7 23l5-3 5 3-1.21-9.12"]} />;
        const Lightbulb = (p) => <IconBase {...p} d={["M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5", "M9 18h6", "M10 22h4"]} />;
        const Minus = (p) => <IconBase {...p} d="M5 12h14" />;
        const Plus = (p) => <IconBase {...p} d={["M12 5v14", "M5 12h14"]} />;
        const Apple = (p) => <IconBase {...p} d={["M12 21c-3.5 0-7-4-7-9 0-3.5 2.5-6 5.5-6 1.5 0 3.5 1 3.5 1s2-1 3.5-1c3 0 5.5 2.5 5.5 6 0 5-3.5 9-7 9z", "M12 6c0-2.5 1-4 3-5"]} />;

        // --- å…ƒä»¶ï¼š3D é¦¬å¡é¾è‰²ç³»æŒ‰éˆ• ---
        const CuteButton = ({ onClick, color, children, className = "", disabled = false }) => {
            const colorClasses = {
                blue: "bg-sky-200 hover:bg-sky-300 shadow-[0_6px_0_#7dd3fc] border-sky-300 text-sky-700",
                pink: "bg-rose-200 hover:bg-rose-300 shadow-[0_6px_0_#fda4af] border-rose-300 text-rose-700",
                green: "bg-emerald-200 hover:bg-emerald-300 shadow-[0_6px_0_#6ee7b7] border-emerald-300 text-emerald-700",
                yellow: "bg-amber-200 hover:bg-amber-300 shadow-[0_6px_0_#fcd34d] border-amber-300 text-amber-700",
                purple: "bg-violet-200 hover:bg-violet-300 shadow-[0_6px_0_#c4b5fd] border-violet-300 text-violet-700",
                gray: "bg-slate-200 hover:bg-slate-300 shadow-[0_6px_0_#cbd5e1] border-slate-300 text-slate-500",
                orange: "bg-orange-200 hover:bg-orange-300 shadow-[0_6px_0_#fdba74] border-orange-300 text-orange-700",
            };

            const selectedColor = disabled ? colorClasses.gray : (colorClasses[color] || colorClasses.blue);

            return (
                <button
                onClick={!disabled ? onClick : undefined}
                disabled={disabled}
                className={`
                    ${selectedColor} 
                    font-bold py-3 px-6 rounded-2xl 
                    transform transition-all duration-150 
                    active:translate-y-1 active:shadow-none 
                    flex items-center justify-center gap-2
                    text-lg md:text-xl border-2 border-opacity-50
                    ${disabled ? 'opacity-70 cursor-not-allowed' : ''}
                    ${className}
                `}
                >
                {children}
                </button>
            );
        };

        // --- è³‡æ–™èˆ‡è¼”åŠ©å‡½å¼ ---
        const encouragePhrases = [
            "æ²’é—œä¿‚ï¼Œå†è©¦ä¸€æ¬¡çœ‹çœ‹ï¼",
            "ä¸è¦ç°å¿ƒï¼Œä½ å¯ä»¥çš„ï¼",
            "æƒ³ä¸€ä¸‹ï¼Œå¿«ç­”å°å›‰ï¼",
            "åŠ æ²¹ï¼Œå†ç®—ä¸€æ¬¡ï¼",
            "å¤±æ•—æ˜¯æˆåŠŸä¹‹æ¯ï¼Œå†ä¾†ï¼"
        ];

        const successPhrases = [
            "å¤ªæ£’äº†ï¼ä½ çœŸè°æ˜ï¼",
            "ç­”å°äº†ï¼å¥½å²å®³ï¼",
            "è¶…ç´šå„ªç§€ï¼",
            "ä¸€ç™¾åˆ†ï¼ç¹¼çºŒä¿æŒï¼",
            "å“‡ï¼ä½ æ˜¯ä¹˜æ³•å°å¤©æ‰ï¼"
        ];

        // ä¿®æ”¹å¾Œçš„ç”¢ç”Ÿé¡Œç›®å‡½å¼ï¼šæ”¯æ´æŒ‡å®š multiplicand
        const generateQuestion = (min = 1, max = 9, fixedMultiplicand = null) => {
            const a = fixedMultiplicand !== null ? fixedMultiplicand : Math.floor(Math.random() * (max - min + 1)) + min;
            const b = Math.floor(Math.random() * 9) + 1;
            return { a, b, answer: a * b };
        };

        const generateChallengeQuestion = (min, max, allowMissingFactor = false) => {
            const a = Math.floor(Math.random() * (max - min + 1)) + min;
            const b = Math.floor(Math.random() * 9) + 1;
            const product = a * b;

            let missing = 'product'; 
            let answer = product;

            if (allowMissingFactor) {
                const r = Math.random();
                if (r < 0.35) {
                missing = 'a'; 
                answer = a;
                } else if (r < 0.7) {
                missing = 'b'; 
                answer = b;
                }
            }
            return { a, b, product, missing, answer };
        };

        const generateOptions = (correctAnswer) => {
            const options = new Set([correctAnswer]);
            while (options.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5; 
                if (offset === 0) offset = 1;
                const val = correctAnswer + offset;
                if (val > 0) options.add(val);
            }
            return Array.from(options).sort(() => Math.random() - 0.5);
        };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [mode, setMode] = useState('menu'); 
            
            // ç§»é™¤è¼‰å…¥ç•«é¢ (ç•¶ App å…ƒä»¶æˆåŠŸè¼‰å…¥æ™‚)
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            }, []);

            return (
                <div className="min-h-screen bg-rose-50 font-sans selection:bg-rose-200 text-slate-600">
                <div className="max-w-2xl mx-auto min-h-screen flex flex-col relative overflow-hidden">
                    
                    {/* èƒŒæ™¯è£é£¾ */}
                    <div className="absolute top-[-5%] left-[-5%] w-64 h-64 bg-yellow-100 rounded-full opacity-60 pointer-events-none"></div>
                    <div className="absolute bottom-[-5%] right-[-5%] w-80 h-80 bg-sky-100 rounded-full opacity-60 pointer-events-none"></div>
                    <div className="absolute top-[40%] right-[-10%] w-32 h-32 bg-purple-100 rounded-full opacity-40 pointer-events-none"></div>
                    
                    {/* ä¸»è¦å…§å®¹å€ */}
                    <div className="flex-1 flex flex-col p-6 z-10">
                    
                    {mode === 'menu' && <MainMenu setMode={setMode} />}
                    {mode === 'learn' && <LearnMode goBack={() => setMode('menu')} />}
                    {mode === 'recite' && <ReciteMode goBack={() => setMode('menu')} />}
                    {mode === 'practice' && <PracticeMode goBack={() => setMode('menu')} />}
                    {mode === 'challenge' && <ChallengeMode goBack={() => setMode('menu')} />}
                    
                    </div>
                </div>
                </div>
            );
        }

        // --- é¸å–®æ¨¡å¼ ---
        function MainMenu({ setMode }) {
            return (
                <div className="flex flex-col items-center justify-center flex-1 space-y-12 animate-fade-in py-8">
                <div className="text-center relative pt-4 mb-4">
                    <div className="relative inline-block group cursor-default">
                        <h1 className="text-4xl sm:text-5xl md:text-7xl font-black tracking-tight z-10 flex items-center justify-center gap-2 md:gap-3 whitespace-nowrap">
                        <span className="text-sky-400 transform -rotate-6 inline-block filter drop-shadow-sm">99</span>
                        <span className="text-rose-400 filter drop-shadow-sm">ä¹˜æ³•æŒ‘æˆ°ç‹</span>
                        </h1>
                        <Star className="absolute -top-6 -right-8 text-yellow-300 fill-yellow-300 w-12 h-12 z-20 animate-bounce" />
                        <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 w-32 h-3 bg-rose-200/50 rounded-full blur-[2px]"></div>
                    </div>
                </div>

                <div className="grid gap-4 w-full max-w-sm mt-4">
                    <CuteButton color="yellow" onClick={() => setMode('learn')} className="w-full text-xl py-5">
                    <Lightbulb size={28} /> é­”æ³•æ•™å­¸ <span className="text-sm font-normal ml-1 text-amber-600/70">(å…ˆä¾†å­¸è§€å¿µ)</span>
                    </CuteButton>

                    <CuteButton color="blue" onClick={() => setMode('recite')} className="w-full text-xl py-5">
                    <BookOpen size={28} /> èƒŒèª¦å¡ç‰‡
                    </CuteButton>
                    
                    <CuteButton color="green" onClick={() => setMode('practice')} className="w-full text-xl py-5">
                    <Play size={28} /> è¼•é¬†ç·´ç¿’
                    </CuteButton>
                    
                    <CuteButton color="pink" onClick={() => setMode('challenge')} className="w-full text-xl py-5">
                    <Trophy size={28} /> å‹‡è€…é—–é—œ
                    </CuteButton>
                </div>
                </div>
            );
        }

        // --- æ•™å­¸æ¨¡å¼ ---
        function LearnMode({ goBack }) {
            const [multiplicand, setMultiplicand] = useState(3);
            const [multiplier, setMultiplier] = useState(2);

            const handleMultiplicandChange = (delta) => {
                const newVal = multiplicand + delta;
                if (newVal >= 1 && newVal <= 9) setMultiplicand(newVal);
            };

            const handleMultiplierChange = (delta) => {
                const newVal = multiplier + delta;
                if (newVal >= 1 && newVal <= 9) setMultiplier(newVal);
            };

            return (
                <div className="flex flex-col flex-1 h-full animate-fade-in">
                <div className="flex items-center justify-between mb-4">
                    <CuteButton color="gray" onClick={goBack} className="!py-2 !px-4 !text-sm">
                    <ArrowLeft size={20} /> è¿”å›
                    </CuteButton>
                    <h2 className="text-2xl font-bold text-amber-500 bg-amber-50 px-4 py-1 rounded-full border-2 border-amber-100">
                        é­”æ³•æ•™å­¸
                    </h2>
                    <div className="w-20"></div> 
                </div>

                <div className="bg-white rounded-3xl p-6 shadow-lg border-4 border-amber-100 mb-6 flex flex-col items-center">
                    <div className="flex items-end gap-2 md:gap-4 mb-4">
                        <div className="flex flex-col items-center group">
                            <div className="text-5xl md:text-6xl font-black text-rose-400 bg-rose-50 w-16 h-20 md:w-20 md:h-24 rounded-2xl flex items-center justify-center border-2 border-rose-100 mb-2 transition-all group-hover:scale-110">
                                {multiplicand}
                            </div>
                            <div className="text-xs text-rose-600 bg-rose-100 px-2 py-1 rounded-full font-bold">è¢«ä¹˜æ•¸</div>
                            <div className="text-[10px] text-slate-400 mt-1">æ¯ç›¤æœ‰å¹¾é¡†</div>
                        </div>

                        <div className="text-3xl text-slate-300 pb-12 font-black">Ã—</div>

                        <div className="flex flex-col items-center group">
                            <div className="text-5xl md:text-6xl font-black text-sky-400 bg-sky-50 w-16 h-20 md:w-20 md:h-24 rounded-2xl flex items-center justify-center border-2 border-sky-100 mb-2 transition-all group-hover:scale-110">
                                {multiplier}
                            </div>
                            <div className="text-xs text-sky-600 bg-sky-100 px-2 py-1 rounded-full font-bold">ä¹˜æ•¸</div>
                            <div className="text-[10px] text-slate-400 mt-1">å…±æœ‰å¹¾ç›¤</div>
                        </div>

                        <div className="text-3xl text-slate-300 pb-12 font-black">=</div>

                        <div className="flex flex-col items-center">
                            <div className="text-5xl md:text-6xl font-black text-emerald-500 bg-emerald-50 w-20 h-20 md:w-24 md:h-24 rounded-full flex items-center justify-center border-4 border-emerald-100 mb-2 shadow-inner">
                                {multiplicand * multiplier}
                            </div>
                            <div className="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full font-bold">ç© (ç­”æ¡ˆ)</div>
                            <div className="text-[10px] text-slate-400 mt-1">å…¨éƒ¨å¤šå°‘é¡†</div>
                        </div>
                    </div>

                    <div className="text-center bg-slate-50 px-6 py-3 rounded-xl w-full text-slate-600">
                        <p className="text-lg">
                            æ¯ç›¤æœ‰ <strong className="text-rose-500 text-xl">{multiplicand}</strong> é¡†è˜‹æœï¼Œ
                            å…±æœ‰ <strong className="text-sky-500 text-xl">{multiplier}</strong> ç›¤
                        </p>
                        <p className="text-sm text-slate-400 mt-1">å…¨éƒ¨åŠ èµ·ä¾†å°±æ˜¯ {multiplicand * multiplier} é¡†ï¼</p>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="bg-rose-50 rounded-2xl p-3 flex flex-col items-center border-2 border-rose-100">
                        <span className="text-sm font-bold text-rose-600 mb-2">èª¿æ•´æ¯ç›¤å¹¾é¡†</span>
                        <div className="flex items-center gap-3">
                            <button onClick={() => handleMultiplicandChange(-1)} className="w-8 h-8 rounded-full bg-white text-rose-500 shadow flex items-center justify-center hover:bg-rose-100 font-bold disabled:opacity-50" disabled={multiplicand <= 1}><Minus size={16}/></button>
                            <span className="text-2xl font-black text-rose-500 w-6 text-center">{multiplicand}</span>
                            <button onClick={() => handleMultiplicandChange(1)} className="w-8 h-8 rounded-full bg-white text-rose-500 shadow flex items-center justify-center hover:bg-rose-100 font-bold disabled:opacity-50" disabled={multiplicand >= 9}><Plus size={16}/></button>
                        </div>
                    </div>
                    <div className="bg-sky-50 rounded-2xl p-3 flex flex-col items-center border-2 border-sky-100">
                        <span className="text-sm font-bold text-sky-600 mb-2">èª¿æ•´æœ‰å¹¾ç›¤</span>
                        <div className="flex items-center gap-3">
                            <button onClick={() => handleMultiplierChange(-1)} className="w-8 h-8 rounded-full bg-white text-sky-500 shadow flex items-center justify-center hover:bg-sky-100 font-bold disabled:opacity-50" disabled={multiplier <= 1}><Minus size={16}/></button>
                            <span className="text-2xl font-black text-sky-500 w-6 text-center">{multiplier}</span>
                            <button onClick={() => handleMultiplierChange(1)} className="w-8 h-8 rounded-full bg-white text-sky-500 shadow flex items-center justify-center hover:bg-sky-100 font-bold disabled:opacity-50" disabled={multiplier >= 9}><Plus size={16}/></button>
                        </div>
                    </div>
                </div>

                <div className="flex-1 bg-white/50 border-2 border-dashed border-slate-200 rounded-3xl p-4 overflow-y-auto">
                    <div className="flex flex-wrap content-start justify-center gap-4 min-h-full">
                        {Array.from({ length: multiplier }).map((_, groupIndex) => (
                            <div key={groupIndex} className="bg-white border-2 border-sky-200 rounded-2xl p-3 shadow-sm relative w-32 min-h-[100px] flex flex-col items-center">
                                <div className="absolute -top-3 bg-sky-400 text-white text-[10px] px-2 py-0.5 rounded-full shadow-sm">
                                    ç¬¬ {groupIndex + 1} ç›¤
                                </div>
                                <div className="flex flex-wrap justify-center gap-1 mt-2">
                                    {Array.from({ length: multiplicand }).map((_, itemIndex) => (
                                        <Apple 
                                            key={itemIndex} 
                                            size={20} 
                                            className="text-rose-400 fill-rose-400 animate-scale-in" 
                                            style={{animationDelay: `${itemIndex * 0.1}s`}}
                                        />
                                    ))}
                                </div>
                                <div className="mt-auto pt-2 text-xs text-slate-400 font-bold">
                                    {multiplicand} é¡†
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
                </div>
            );
        }

        // --- èƒŒèª¦æ¨¡å¼ ---
        function ReciteMode({ goBack }) {
            const [number, setNumber] = useState(2);

            return (
                <div className="flex flex-col flex-1 animate-fade-in">
                <div className="flex items-center justify-between mb-6">
                    <CuteButton color="gray" onClick={goBack} className="!py-2 !px-4 !text-sm">
                    <ArrowLeft size={20} /> è¿”å›
                    </CuteButton>
                    <h2 className="text-3xl font-bold text-sky-500">èƒŒèª¦å¡ç‰‡</h2>
                    <div className="w-20"></div> 
                </div>

                <div className="flex gap-2 overflow-x-auto pb-4 mb-4 hide-scrollbar justify-center">
                    {[2,3,4,5,6,7,8,9].map(n => (
                    <button
                        key={n}
                        onClick={() => setNumber(n)}
                        className={`
                        w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold transition-all
                        ${number === n 
                            ? 'bg-sky-400 text-white shadow-lg scale-110' 
                            : 'bg-white text-sky-400 hover:bg-sky-100'}
                        `}
                    >
                        {n}
                    </button>
                    ))}
                </div>

                <div className="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-xl border-4 border-sky-100 flex-1 flex flex-col justify-center items-center relative overflow-hidden">
                    <h3 className="text-4xl font-black text-sky-500 mb-6 bg-sky-50 px-8 py-2 rounded-full">
                        {number} çš„ä¹˜æ³•
                    </h3>

                    <div className="grid grid-cols-1 gap-3 w-full max-w-md text-center">
                        {[1,2,3,4,5,6,7,8,9].map(m => (
                        <div key={m} className="bg-slate-50 hover:bg-yellow-50 transition-colors p-3 rounded-xl text-2xl font-bold text-slate-600 flex justify-center gap-2 shadow-sm border border-slate-100">
                            <span className="text-sky-500">{number}</span>
                            <span className="text-slate-300">x</span>
                            <span className="text-rose-400">{m}</span>
                            <span className="text-slate-300">=</span>
                            <span className="text-emerald-500">{number * m}</span>
                        </div>
                        ))}
                    </div>
                </div>
                </div>
            );
        }

        // --- ç·´ç¿’æ¨¡å¼ (å·²æ›´æ–°ï¼šæ–°å¢é¸å–® 2~9) ---
        function PracticeMode({ goBack }) {
            // practiceStage: 'setup' (é¸æ“‡æ•¸å­—) æˆ– 'playing' (ç­”é¡Œä¸­)
            const [practiceStage, setPracticeState] = useState('setup');
            const [targetNumber, setTargetNumber] = useState(null); // null = ç¶œåˆ(2-9), æ•¸å­— = æŒ‡å®š
            
            const [question, setQuestion] = useState(null);
            const [options, setOptions] = useState([]);
            const [feedback, setFeedback] = useState(null); 
            const [message, setMessage] = useState("é¸é¸çœ‹ï¼Œç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ");

            // é–‹å§‹ç·´ç¿’çš„åˆå§‹åŒ–
            const startPractice = (target) => {
                setTargetNumber(target);
                setPracticeState('playing');
                generateNewQuestion(target);
            };

            const generateNewQuestion = (target) => {
                const q = generateQuestion(2, 9, target); // target å¦‚æœæ˜¯ nullï¼Œå°±æœƒéš¨æ©Ÿ 2-9
                setQuestion(q);
                setOptions(generateOptions(q.answer));
                setFeedback(null);
                setMessage("é¸é¸çœ‹ï¼Œç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ");
            };

            const handleAnswer = (val) => {
                if (feedback === 'correct') return;

                if (val === question.answer) {
                    setFeedback('correct');
                    const randomMsg = successPhrases[Math.floor(Math.random() * successPhrases.length)];
                    setMessage(randomMsg);
                } else {
                    setFeedback('wrong');
                    const randomMsg = encouragePhrases[Math.floor(Math.random() * encouragePhrases.length)];
                    setMessage(randomMsg);
                }
            };

            const nextQuestion = () => {
                generateNewQuestion(targetNumber);
            };

            // å¦‚æœé‚„åœ¨è¨­å®šéšæ®µï¼Œé¡¯ç¤ºé¸æ“‡é¸å–®
            if (practiceStage === 'setup') {
                return (
                    <div className="flex flex-col flex-1 max-w-lg mx-auto w-full animate-fade-in">
                        <div className="flex items-center justify-between mb-8">
                            <CuteButton color="gray" onClick={goBack} className="!py-2 !px-4 !text-sm">
                                <ArrowLeft size={20} /> è¿”å›ä¸»å–®
                            </CuteButton>
                            <h2 className="text-2xl font-bold text-emerald-600 bg-emerald-100 px-4 py-1 rounded-full">
                                é¸æ“‡ç·´ç¿’ç¯„åœ
                            </h2>
                        </div>
                        
                        <div className="bg-white rounded-3xl p-6 shadow-xl border-4 border-emerald-100 flex flex-col items-center text-center">
                            <p className="text-xl text-slate-500 mb-4 font-bold">ä½ è¦ç·´ç¿’å“ªå€‹æ•¸å­—å‘¢ï¼Ÿ</p>
                            
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 w-full mb-4">
                                {[2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                                    <CuteButton 
                                        key={num} 
                                        // Simple color cycling
                                        color={
                                            num === 2 ? "blue" :
                                            num === 3 ? "pink" :
                                            num === 4 ? "yellow" :
                                            num === 5 ? "purple" :
                                            num === 6 ? "green" :
                                            num === 7 ? "orange" : 
                                            num === 8 ? "blue" : "pink"
                                        } 
                                        onClick={() => startPractice(num)} 
                                        className="text-lg !py-3"
                                    >
                                        {num} çš„ä¹˜æ³•
                                    </CuteButton>
                                ))}
                                <div className="col-span-2 md:col-span-1">
                                    <CuteButton color="purple" onClick={() => startPractice(null)} className="text-lg !py-3 w-full h-full">
                                        ç¶œåˆæŒ‘æˆ°
                                    </CuteButton>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // é€²å…¥ç­”é¡Œéšæ®µ
            return (
                <div className="flex flex-col flex-1 max-w-lg mx-auto w-full animate-fade-in">
                <div className="flex items-center justify-between mb-8">
                    <CuteButton color="gray" onClick={() => setPracticeState('setup')} className="!py-2 !px-4 !text-sm">
                        <ArrowLeft size={20} /> é‡é¸ç¯„åœ
                    </CuteButton>
                    <div className="bg-emerald-100 text-emerald-600 px-4 py-2 rounded-full font-bold text-sm md:text-base">
                        {targetNumber ? `${targetNumber} çš„ä¹˜æ³•ç·´ç¿’` : 'ç¶œåˆç·´ç¿’ (2-9)'}
                    </div>
                </div>

                <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white w-full rounded-3xl p-8 shadow-2xl border-b-8 border-emerald-100 text-center relative mb-8">
                    
                    <div className="text-7xl font-black text-slate-700 flex justify-center gap-4 items-center mb-4">
                        <span className="text-sky-400">{question.a}</span>
                        <span className="text-slate-200 text-5xl">x</span>
                        <span className="text-rose-400">{question.b}</span>
                    </div>
                    
                    <div className="text-4xl font-bold text-slate-300">
                        = <span className="text-slate-200">?</span>
                    </div>

                    {feedback === 'correct' && (
                        <div className="absolute inset-0 flex items-center justify-center bg-white/90 rounded-3xl backdrop-blur-sm animate-scale-in">
                        <CheckCircle size={80} className="text-emerald-400" />
                        </div>
                    )}
                    {feedback === 'wrong' && (
                        <div className="absolute top-4 right-4 animate-shake">
                        <XCircle size={40} className="text-rose-300 opacity-60" />
                        </div>
                    )}
                    </div>

                    <div className={`text-xl font-bold mb-8 px-6 py-3 rounded-2xl transition-all ${
                    feedback === 'correct' ? 'bg-emerald-100 text-emerald-600' : 
                    feedback === 'wrong' ? 'bg-amber-100 text-amber-600' : 'bg-white/60 text-slate-500'
                    }`}>
                    {message}
                    </div>

                    {feedback !== 'correct' ? (
                    <div className="grid grid-cols-2 gap-4 w-full">
                        {options.map((opt, idx) => (
                        <CuteButton 
                            key={idx} 
                            color="yellow" 
                            onClick={() => handleAnswer(opt)}
                            className="text-3xl font-black !py-6"
                        >
                            {opt}
                        </CuteButton>
                        ))}
                    </div>
                    ) : (
                    <CuteButton color="green" onClick={nextQuestion} className="w-full text-2xl animate-bounce">
                        ä¸‹ä¸€é¡Œ <RefreshCw size={24} />
                    </CuteButton>
                    )}
                </div>
                </div>
            );
        }

        // --- é—–é—œæ¨¡å¼ ---
        function ChallengeMode({ goBack }) {
            const [gameState, setGameState] = useState('intro');
            const [lives, setLives] = useState(3);
            const [score, setScore] = useState(0);
            const [level, setLevel] = useState(1);
            const [question, setQuestion] = useState(null);
            const [options, setOptions] = useState([]);
            const [message, setMessage] = useState("");
            const [isWrongAnim, setIsWrongAnim] = useState(false);

            const getLevelConfig = (lvl) => {
                if (lvl === 1) return { min: 2, max: 4, label: "é—œå¡ 1: åˆç´šæŒ‘æˆ°", allowMissingFactor: false };
                if (lvl === 2) return { min: 5, max: 7, label: "é—œå¡ 2: é€²éšæŒ‘æˆ°", allowMissingFactor: true };
                return { min: 2, max: 9, label: "é—œå¡ 3: æœ€çµ‚æŒ‘æˆ°", allowMissingFactor: true };
            };

            const startGame = () => {
                setLives(3);
                setScore(0);
                setLevel(1);
                setMessage("");
                setGameState('playing');
                nextLevelQuestion(1);
            };

            const nextLevelQuestion = (currentLevel) => {
                const config = getLevelConfig(currentLevel);
                const q = generateChallengeQuestion(config.min, config.max, config.allowMissingFactor);
                setQuestion(q);
                setOptions(generateOptions(q.answer));
            };

            const handleAnswer = (val) => {
                if (val === question.answer) {
                const newScore = score + 1;
                setScore(newScore);
                
                if (newScore === 5) {
                    setLevel(2);
                    setMessage("å‡ç´šäº†ï¼é–‹å§‹å‡ºç¾å¡«ç©ºé¡Œï¼");
                    setTimeout(() => setMessage(""), 2000);
                } else if (newScore === 10) {
                    setLevel(3);
                    setMessage("å¤ªå¼·äº†ï¼æœ€å¾Œè¡åˆºï¼");
                    setTimeout(() => setMessage(""), 2000);
                } else if (newScore >= 15) {
                    setGameState('won');
                    return;
                }

                nextLevelQuestion(newScore >= 10 ? 3 : (newScore >= 5 ? 2 : 1));

                } else {
                const newLives = lives - 1;
                setLives(newLives);
                setMessage(encouragePhrases[Math.floor(Math.random() * encouragePhrases.length)]);
                setIsWrongAnim(true);
                setTimeout(() => setIsWrongAnim(false), 500);

                if (newLives <= 0) {
                    setGameState('lost');
                }
                }
            };

            if (gameState === 'won') {
                return (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-scale-in">
                    <Award size={100} className="text-amber-400 drop-shadow-lg" />
                    <h2 className="text-4xl font-black text-rose-500">æ­å–œé€šé—œï¼</h2>
                    <p className="text-xl text-slate-500">ä½ æ˜¯æœ€å¼·çš„ä¹˜æ³•æŒ‘æˆ°ç‹ï¼</p>
                    <div className="flex gap-4 mt-8">
                    <CuteButton color="gray" onClick={goBack}>å›é¦–é </CuteButton>
                    <CuteButton color="green" onClick={startGame}>å†ç©ä¸€æ¬¡</CuteButton>
                    </div>
                </div>
                );
            }

            if (gameState === 'lost') {
                return (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-6 animate-scale-in">
                    <Frown size={100} className="text-slate-300" />
                    <h2 className="text-3xl font-black text-slate-600">æŒ‘æˆ°å¤±æ•—...</h2>
                    <p className="text-xl text-slate-500">æ²’é—œä¿‚ï¼Œä¼‘æ¯ä¸€ä¸‹å†è©¦è©¦ï¼</p>
                    <div className="flex gap-4 mt-8">
                    <CuteButton color="gray" onClick={goBack}>å›é¦–é </CuteButton>
                    <CuteButton color="blue" onClick={startGame}>é‡æ–°æŒ‘æˆ°</CuteButton>
                    </div>
                </div>
                );
            }

            if (gameState === 'intro') {
                return (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-6 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border-b-8 border-rose-100 max-w-sm w-full">
                    <h2 className="text-3xl font-bold text-rose-500 mb-6">æŒ‘æˆ°è¦å‰‡</h2>
                    <ul className="text-left space-y-4 text-lg text-slate-600 mb-8">
                        <li className="flex items-center gap-3"><Heart className="text-rose-400 fill-current" size={24}/> æœ‰ 3 é¡†æ„›å¿ƒç”Ÿå‘½å€¼</li>
                        <li className="flex items-center gap-3"><Trophy className="text-amber-400 fill-current" size={24}/> ç­”å° 15 é¡Œå°±ç²å‹</li>
                        <li className="flex items-center gap-3"><Star className="text-violet-400 fill-current" size={24}/> è¶Šå¾Œé¢é¡Œç›®è¶Šéˆæ´»å–”ï¼</li>
                    </ul>
                    <CuteButton color="pink" onClick={startGame} className="w-full text-2xl">
                        é–‹å§‹æŒ‘æˆ°ï¼
                    </CuteButton>
                    </div>
                    <button onClick={goBack} className="text-slate-400 underline decoration-dashed hover:text-slate-600">ä¸ç©äº†ï¼Œå›é¦–é </button>
                </div>
                );
            }

            return (
                <div className="flex flex-col flex-1 max-w-lg mx-auto w-full animate-fade-in">
                <div className="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between mb-6">
                    <div className="flex gap-1">
                    {[...Array(3)].map((_, i) => (
                        <Heart 
                        key={i} 
                        className={`${i < lives ? 'text-rose-400 fill-current' : 'text-slate-200'} transition-all`} 
                        size={28} 
                        />
                    ))}
                    </div>
                    <div className="font-bold text-slate-600">
                    å¾—åˆ†: <span className="text-2xl text-sky-500">{score}</span> / 15
                    </div>
                </div>

                <div className="flex justify-between items-center mb-4 px-2">
                    <span className="text-sm font-bold bg-violet-100 text-violet-600 px-3 py-1 rounded-lg">
                    {getLevelConfig(level).label}
                    </span>
                    <button onClick={goBack} className="text-slate-400 text-sm hover:text-slate-600">é€€å‡º</button>
                </div>

                <div className={`
                    bg-white border-4 border-rose-100 rounded-3xl p-8 mb-6 text-center shadow-lg relative
                    transition-transform duration-100
                    ${isWrongAnim ? 'translate-x-2 border-rose-300 bg-rose-50' : ''}
                `}>
                    <div className="text-6xl font-black text-slate-700 flex justify-center gap-3 items-center">
                        {question.missing === 'a' ? (
                            <span className="text-sky-400 border-b-4 border-sky-200 px-2 animate-pulse">?</span>
                        ) : (
                            <span className="text-sky-400">{question.a}</span>
                        )}
                        
                        <span className="text-slate-200">x</span>
                        
                        {question.missing === 'b' ? (
                            <span className="text-rose-400 border-b-4 border-rose-200 px-2 animate-pulse">?</span>
                        ) : (
                            <span className="text-rose-400">{question.b}</span>
                        )}
                        
                        <span className="text-slate-200">=</span>
                        
                        {question.missing === 'product' ? (
                            <span className="text-amber-400 border-b-4 border-amber-200 px-2 animate-pulse">?</span>
                        ) : (
                            <span className="text-amber-400">{question.product}</span>
                        )}
                    </div>
                </div>

                <div className="h-8 text-center mb-4 font-bold text-lg text-amber-500 animate-pulse">
                    {message}
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {options.map((opt, idx) => (
                    <CuteButton 
                        key={idx} 
                        color="blue" 
                        onClick={() => handleAnswer(opt)}
                        className="text-3xl font-black !py-6"
                    >
                        {opt}
                    </CuteButton>
                    ))}
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>